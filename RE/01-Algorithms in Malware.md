# 01 - Algorithms in Malware


## Encryption

**Symmetric**

- RC4 (Dridex, IcedID)
- AES (PandaBander, Trickbot)
- 3RES (Turla PowerShell Loader)
- Serpent (ISFB)
- Salsa20 (REvil, GandCrab v4.0)
- Misty-1 (Turla Outlook Backdoor)

**Asymmetric**

- RSA (Phobos, ISFB, WannaCry)
- ECDH (Petya)

**Which one is used?**

First, look into the following APIs:

- WinCrypt API (usually obfuscate - depending on sophistication)
  - CryptCreateHash (Hashes data, returns handle to Crypto Service Provider object)
  - CryptEncrypt/Decrypt
  - CryptGenKey

Then take a look at the `ALG_ID`, which incidates the algorithm being used.

- [ALG_ID](https://learn.microsoft.com/en-us/windows/win32/seccrypto/alg-id)

**Non-API**

- Constants 
  - typically hardcoded values required in order to output the correct data (easy to detect)
  - Constant range from substitution boxes, **magic numbers**, or even just certain values used for math operations

- Flow
  - Hard to recognize - require prior knowledge of the algorihm - although there are certain excepions
  - Example of recognizable flows: RC4 KSA, PRGA, XOR sages, lengh of the Serpent CBC algorithm

**RC4**

![image](https://user-images.githubusercontent.com/38507703/201405808-afe3fffe-7283-4262-82b2-915b71948848.png)

Example: NetWalker Ransomware RC4 - `cmp ecx, 100h`

- Take note on the **constant** `100h`

![image](https://user-images.githubusercontent.com/38507703/201406160-b51ef658-5f9f-41eb-bd67-8195de3a1295.png)

**AES Encryption**

![image](https://user-images.githubusercontent.com/38507703/201407306-fd312513-abfb-4e95-85e0-4d391b961312.png)

- AES Yara example:

```
rule RijnDael_AES

{
  strings:
    $c0 = { A5 63 63 C6 84 7C 7C F8 }
  condition:
    $c0
}
```

- Trick Loader AES - hash_rounds + sbox

![image](https://user-images.githubusercontent.com/38507703/201408328-2e9dc739-3f9f-4bd8-bd80-6748f171d4ee.png)


**3DES**

![image](https://user-images.githubusercontent.com/38507703/201408379-1fa16aee-96e0-42d8-8863-5c9dc2c6cbac.png)

- K1, K2, K3
